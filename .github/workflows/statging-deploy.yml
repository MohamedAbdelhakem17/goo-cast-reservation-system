name: ğŸš€ Deploy to Staging Environment

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v3

      - name: ğŸš€ Deploy to staging server via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸš€ Starting Staging Deployment - Goo Cast Studio         â•‘"
            echo "â•‘  ğŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S')                â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            echo "ğŸ“‚ Navigating to deployment directory..."
            cd /var/www/staging-goocast
            echo "âœ… Current directory: $(pwd)"
            echo ""
            
            echo "ğŸ”„ Fetching latest changes from repository..."
            git fetch origin
            echo "âœ… Repository fetched successfully"
            echo ""
            
            echo "ğŸ”„ Resetting to latest dev branch..."
            git reset --hard origin/dev
            COMMIT_HASH=$(git rev-parse --short HEAD)
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo "âœ… Deployed commit: $COMMIT_HASH"
            echo "ğŸ“ Commit message: $COMMIT_MSG"
            echo ""
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ğŸ“¦ Building Client Application                           â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd client
            echo "ğŸ”§ Installing client dependencies..."
            npm ci --silent
            echo "âœ… Client dependencies installed"
            echo ""
            
            echo "ğŸ—ï¸  Building production client bundle..."
            npm run build
            echo "âœ… Client build completed successfully"
            echo ""
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âš™ï¸  Updating Server Application                          â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd ../server
            echo "ğŸ”§ Installing server dependencies..."
            npm ci --silent
            echo "âœ… Server dependencies installed"
            echo ""
            
            echo "ğŸ”„ Restarting application with PM2..."
            pm2 restart staging-goocast
            echo "âœ… Application restarted successfully"
            echo ""
            
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  âœ¨ Deployment Completed Successfully!                    â•‘"
            echo "â•‘  ğŸŒ Environment: Staging                                   â•‘"
            echo "â•‘  ğŸ“… Completed at: $(date '+%Y-%m-%d %H:%M:%S')             â•‘"
            echo "â•‘  ğŸ”– Version: $COMMIT_HASH                                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: âœ… Deployment status
        if: success()
        run: |
          echo "::notice::âœ… Staging deployment completed successfully!"
          
      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo "::error::âŒ Staging deployment failed! Please check the logs above for details."
